function init(){createScene(),update()}function createScene(){hasCollided=!1,score=0,treesInPath=[],treesPool=[],clock=new THREE.Clock,clock.start(),heroRollingSpeed=rollingSpeed*worldRadius/heroRadius/5,sphericalHelper=new THREE.Spherical,pathAngleValues=[1.52,1.57,1.62],sceneWidth=window.innerWidth,sceneHeight=window.innerHeight,scene=new THREE.Scene,scene.fog=new THREE.FogExp2(15794160,.14),camera=new THREE.PerspectiveCamera(60,sceneWidth/sceneHeight,.1,1e3),renderer=new THREE.WebGLRenderer({alpha:!0}),renderer.setClearColor(16775930,1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.setSize(sceneWidth,sceneHeight),dom=document.getElementById("iceRoller"),dom.appendChild(renderer.domElement),createTreesPool(),addWorld(),addHero(),addLight(),addExplosion(),camera.position.z=6.5,camera.position.y=2.5,window.addEventListener("resize",onWindowResize,!1),document.onkeydown=handleKeyDown,scoreText=document.createElement("div"),scoreText.style.color="#5f5f5f",scoreText.style.fontFamily="Arial",scoreText.style.fontSize="40px",scoreText.style.position="absolute",scoreText.style.width=100,scoreText.style.height=100,scoreText.innerHTML="0",scoreText.style.top="50px",scoreText.style.left="10px",document.body.appendChild(scoreText);var e=document.createElement("div");e.style.position="absolute",e.style.width=100,e.style.height=100,e.style.backgroundColor="yellow",e.style.top="10px",e.style.left="10px",document.body.appendChild(e)}function addExplosion(){particleGeometry=new THREE.Geometry;for(var e=0;particleCount>e;e++){var r=new THREE.Vector3;particleGeometry.vertices.push(r)}var o=new THREE.ParticleBasicMaterial({color:16775930,size:.2});particles=new THREE.Points(particleGeometry,o),scene.add(particles),particles.visible=!1}function createTreesPool(){for(var e,r=10,o=0;r>o;o++)e=createTree(),treesPool.push(e)}function handleKeyDown(e){if(!jumping){var r=!0;37===e.keyCode?currentLane==middleLane?currentLane=leftLane:currentLane==rightLane?currentLane=middleLane:r=!1:39===e.keyCode?currentLane==middleLane?currentLane=rightLane:currentLane==leftLane?currentLane=middleLane:r=!1:(38===e.keyCode&&(bounceValue=.1,jumping=!0),r=!1),r&&(jumping=!0,bounceValue=.06)}}function addHero(){var e=new THREE.DodecahedronGeometry(heroRadius,1),r=new THREE.MeshStandardMaterial({color:15069938,shading:THREE.FlatShading});jumping=!1,heroSphere=new THREE.Mesh(e,r),heroSphere.receiveShadow=!0,heroSphere.castShadow=!0,scene.add(heroSphere),heroSphere.position.y=heroBaseY,heroSphere.position.z=4.8,currentLane=middleLane,heroSphere.position.x=currentLane}function addWorld(){for(var e,r,o=40,n=40,t=new THREE.SphereGeometry(worldRadius,o,n),a=new THREE.MeshStandardMaterial({color:16775930,shading:THREE.FlatShading}),i=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,s=new THREE.Vector3,c=1,h=.5,p=.07,u=1;n-2>u;u++){c=u;for(var E=0;o>E;E++)e=c*o+1,i=t.vertices[E+e].clone(),u%2!==0&&(0==E&&(d=i.clone()),l=t.vertices[E+e+1].clone(),E==o-1&&(l=d),h=.5*Math.random()+.25,i.lerp(l,h)),r=Math.random()*p-p/2,s=i.clone().normalize().multiplyScalar(r),t.vertices[E+e]=i.add(s)}rollingGroundSphere=new THREE.Mesh(t,a),rollingGroundSphere.receiveShadow=!0,rollingGroundSphere.castShadow=!1,rollingGroundSphere.rotation.z=-Math.PI/2,scene.add(rollingGroundSphere),rollingGroundSphere.position.y=-24,rollingGroundSphere.position.z=2,addWorldTrees()}function addLight(){var e=new THREE.HemisphereLight(16775930,0,.9);scene.add(e),sun=new THREE.DirectionalLight(13484485,.9),sun.position.set(12,6,-7),sun.castShadow=!0,scene.add(sun),sun.shadow.mapSize.width=256,sun.shadow.mapSize.height=256,sun.shadow.camera.near=.5,sun.shadow.camera.far=50}function addPathTree(){var e=[0,1,2],r=Math.floor(3*Math.random());addTree(!0,r),e.splice(r,1),Math.random()>.5&&(r=Math.floor(2*Math.random()),addTree(!0,e[r]))}function addWorldTrees(){for(var e=36,r=6.28/36,o=0;e>o;o++)addTree(!1,o*r,!0),addTree(!1,o*r,!1)}function addTree(e,r,o){var n;if(e){if(0==treesPool.length)return;n=treesPool.pop(),n.visible=!0,treesInPath.push(n),sphericalHelper.set(worldRadius-.3,pathAngleValues[r],-rollingGroundSphere.rotation.x+4)}else{n=createTree();var t=0;t=o?1.68+.1*Math.random():1.46-.1*Math.random(),sphericalHelper.set(worldRadius-.3,t,r)}n.position.setFromSpherical(sphericalHelper);var a=rollingGroundSphere.position.clone().normalize(),i=n.position.clone().normalize();n.quaternion.setFromUnitVectors(i,a),n.rotation.x+=Math.random()*(2*Math.PI/10)+-Math.PI/10,rollingGroundSphere.add(n)}function createTree(){var e=8,r=6,o=.15*Math.random()+.05,n=new THREE.Vector3,t=(new THREE.Vector3,new THREE.ConeGeometry(.5,1,e,r)),a=new THREE.MeshStandardMaterial({color:3407667,shading:THREE.FlatShading});n=t.vertices[0].clone();blowUpTree(t.vertices,e,0,o),tightenTree(t.vertices,e,1),blowUpTree(t.vertices,e,2,1.1*o,!0),tightenTree(t.vertices,e,3),blowUpTree(t.vertices,e,4,1.2*o),tightenTree(t.vertices,e,5);var i=new THREE.Mesh(t,a);i.castShadow=!0,i.receiveShadow=!1,i.position.y=.9,i.rotation.y=Math.random()*Math.PI;var l=new THREE.CylinderGeometry(.1,.1,.5),d=new THREE.MeshStandardMaterial({color:8939059,shading:THREE.FlatShading}),s=new THREE.Mesh(l,d);s.position.y=.25;var c=new THREE.Object3D;return c.add(s),c.add(i),c}function blowUpTree(e,r,o,n,t){for(var a,i,l=new THREE.Vector3,d=e[0].clone(),s=0;r>s;s++)a=o*r+1,l=e[s+a].clone(),d.y=l.y,i=l.sub(d),t?s%2===0?(i.normalize().multiplyScalar(n/6),e[s+a].add(i)):(i.normalize().multiplyScalar(n),e[s+a].add(i),e[s+a].y=e[s+a+r].y+.05):s%2!==0?(i.normalize().multiplyScalar(n/6),e[s+a].add(i)):(i.normalize().multiplyScalar(n),e[s+a].add(i),e[s+a].y=e[s+a+r].y+.05)}function tightenTree(e,r,o){for(var n,t,a=new THREE.Vector3,i=e[0].clone(),l=0;r>l;l++)n=o*r+1,a=e[l+n].clone(),i.y=a.y,t=a.sub(i),t.normalize().multiplyScalar(.06),e[l+n].sub(t)}function update(){rollingGroundSphere.rotation.x+=rollingSpeed,heroSphere.rotation.x-=heroRollingSpeed,heroSphere.position.y<=heroBaseY&&(jumping=!1,bounceValue=.04*Math.random()+.005),heroSphere.position.y+=bounceValue,heroSphere.position.x=THREE.Math.lerp(heroSphere.position.x,currentLane,2*clock.getDelta()),bounceValue-=gravity,clock.getElapsedTime()>treeReleaseInterval&&(clock.start(),addPathTree(),hasCollided||(score+=2*treeReleaseInterval,scoreText.innerHTML=score.toString())),doTreeLogic(),doExplosionLogic(),render(),requestAnimationFrame(update)}function doTreeLogic(){var e,r=new THREE.Vector3,o=[];treesInPath.forEach(function(n,t){e=treesInPath[t],r.setFromMatrixPosition(e.matrixWorld),r.z>6&&e.visible?o.push(e):r.distanceTo(heroSphere.position)<=.6&&(console.log("hit"),hasCollided=!0,explode())});var n;o.forEach(function(r,t){e=o[t],n=treesInPath.indexOf(e),treesInPath.splice(n,1),treesPool.push(e),e.visible=!1,console.log("remove tree")})}function doExplosionLogic(){if(particles.visible){for(var e=0;particleCount>e;e++)particleGeometry.vertices[e].multiplyScalar(explosionPower);explosionPower>1.005?explosionPower-=.001:particles.visible=!1,particleGeometry.verticesNeedUpdate=!0}}function explode(){particles.position.y=2,particles.position.z=4.8,particles.position.x=heroSphere.position.x;for(var e=0;particleCount>e;e++){var r=new THREE.Vector3;r.x=-.2+.4*Math.random(),r.y=-.2+.4*Math.random(),r.z=-.2+.4*Math.random(),particleGeometry.vertices[e]=r}explosionPower=1.07,particles.visible=!0}function render(){renderer.render(scene,camera)}function gameOver(){}function onWindowResize(){sceneHeight=window.innerHeight,sceneWidth=window.innerWidth,renderer.setSize(sceneWidth,sceneHeight),camera.aspect=sceneWidth/sceneHeight,camera.updateProjectionMatrix()}var sceneWidth,sceneHeight,camera,scene,renderer,dom,sun,ground,rollingGroundSphere,heroSphere,rollingSpeed=.008,heroRollingSpeed,worldRadius=26,heroRadius=.2,sphericalHelper,pathAngleValues,heroBaseY=1.8,bounceValue=.1,gravity=.005,leftLane=-1,rightLane=1,middleLane=0,currentLane,clock,jumping,treeReleaseInterval=.5,lastTreeReleaseTime=0,treesInPath,treesPool,particleGeometry,particleCount=20,explosionPower=1.06,particles,scoreText,score,hasCollided;init();